---
title: "Case example - working with DATRAS data"
subtitle: "Part 1"
output: 
  html_document:
    fig_height: 4
    fig_width: 8
    highlight: haddock
    theme: united
    toc: yes
    toc_float: yes
---

```{r, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE)
```

TODO: Revamp the whole thing or reverse back to not so "tidied" tidy_le

## Preamble
___

* Here we want to enhance our skills in the use of grammar of data and graphics
* To that end we use the [DATRAS survey data](http://www.ices.dk/marine-data/data-portals/Pages/DATRAS.aspx) as a **case example**.
    * They were retrieved using functions from the xxx-package and then ..., [see](datras_importing_and_tidying.html)
* ....
* .. and end up with some catch per haul and mean abundance trends

... the base data is similar to cpue_per_length_per_haul that is one of the [Datras service product](https://datras.ices.dk/Data_products/Download/Download_Data_public.aspx)

...

### The tables and fields

For those that do not already know, procedure in a groundfish surveys goes quite often like this:

* For each haul, all species are identified and the total numbers/weight caught is recorded.
* Length measurement, sex and maturity of a species is generally based on a subsample of the catch.
* Age samples (something we are not going to worry about here) are quite often based on a smaller subsample than sampled for length.

Given the above the data are often stored in separate tables. Here we have three tables.

#### Station table

Dataframe **tidy_st**, it contains the following fields:

  * __id__: Unique station id which for the DATRAS data is a combination of the variables year, quarter, ship, gear and haulno.
  * __survey__: Survey identification (in the case example "NS-IBTS")
  * __quarter__: The quarter in which the survey is conducted
  * __ship__: Ship identification code
  * __gear__: Gear code
  * __haulno__: XXX
  * __hauldur__: Duration of haul in minutes
  * __shootlat__: Latitude of the haul start location
  * __shootlong__: Longitude of the haul start location
  * __datetime__: Haul start time
  * __depth__: Bottom depth in meters
  * __area__: XXX
  * __subarea__: ICES statistical rectangle
  * __daynight__: Categorization code, "D" or "N"
  * __datatype__: Categorization of ... XXX
  

#### Length table:

Dataframe **tidy_le**, it contains the following fields:

* __id__: Unique station id (see above)
* __latin__: Species latin name
* __length__: Length in centimeters
* __n__: Number of fish by standardized 30 minutes haul duration

## Data munging
___

#### Needed packages

```{r}
library(tidyverse)
library(ggjoy)
theme_set(theme_grey(base_size = 16))
```

**Recall the dplyr verbs (functions)**:

* __filter__: keep rows matching criteria
* __select__: pick columns by name
* __arrange__: order the rows according to a variable
* __mutate__: add new variables
* __summarise__: reduce variables to values
* __group_by__: Group data into rows

#### Load the data

```{r}
load(url("http://www.hafro.is/~einarhj/data/nsibts_tidy.rda"))
```

#### Familiarize yourself with the data

<div class="panel panel-warning">
<div class="panel-heading">Exercise</div>
<div class="panel-body">

1. How many unique stations are there in the tidy_st table?
2. What is the year range of the data?
3. How many stations are taken each year (plot the data)?
4. How many quarters are there in the data?
5. Plot the overall length distribution of the data? Do we have likely outliers?
6. What species has the maximum size? In what year was it caught?

```{r echo = FALSE, eval = FALSE}
nrow(tidy_st)
length(unique(tidy_st$id))    # better, this way you can double check if id is
                              #   really "a primary key"
range(tidy_st$year)
tidy_st %>% 
  group_by(year) %>% 
  count() %>% 
  ggplot(aes(year, n)) + geom_point() + geom_line()
unique(tidy_st$quarter)
tidy_le %>% ggplot(aes(length)) + geom_histogram()
tidy_le %>% filter(length == max(length))
```

</div>
</div>

### A: Catch per haul

We start simple, calculating the catch per haul of a particular species in a particular year.

#### 1. Specify a year and a species

```{r pick}
Year <- 2001
Latin <- "Melanogrammus aeglefinus"
```

#### 2. Subset (filter) the length table

Since the year in the length table is "hidden" in the variable id, we need to extract that using the function `separate`.

```{r le}
le <-
  tidy_le %>% 
  separate(id,
           into = c("year", "quarter", "ship", "gear", "haulno"),
           sep = "_", 
           convert = TRUE, 
           remove = FALSE) %>% 
  filter(year %in% Year,
         latin == Latin)
```

<div class="panel panel-warning">
<div class="panel-heading">Exercise</div>
<div class="panel-body">

* Calculate the total number of fish caught
* Plot the total length frequency distribution of the species and year selected

</div>
</div>

```{r echo = FALSE, eval = FALSE}
sum(le$n)
ggplot(le, aes(length, n)) + geom_col()
```

#### 3. Summarise the abundance distribution per haul

```{r}
le <- 
  le %>% 
  group_by(id) %>% 
  summarise(n = sum(n)) %>% 
  ungroup()
```

We now, have generated an abundance estimates by haul. Lets look at the distribution of cpue:

```{r}
le %>% 
  ggplot(aes(n)) +
  geom_histogram()
```

One observes that the abundance among hauls is quite variable and the distribution is typically scewed, meaning there are a lot of stations where catch is small, few stations were the catch is large.

<div class="panel panel-warning">
<div class="panel-heading">Exercise</div>
<div class="panel-body">

1. How many stations are there in the (filtered) le dataframe?
2. What is the minimum recorded catch in the le dataframe?
3. How many stations, according to the tidy_st table where taken in the selected year? What might be the likely reason for the discrepancy?

```{r echo = FALSE, eval = FALSE}
nrow(le)
le %>% filter(n == min(n))
tidy_st %>% filter(year == Year) %>% nrow()
```

</div>
</div>

### B: Catch per haul per length

In the above code we "collapsed" the data, ignoring length. This is however a variable we are interested in retaining, e.g. we may want to estimate the abundance below a certain length or biomass above a certain length.

We hence modify the code a little further by getting approximate length, here ignoring year:
```{r}
le <-
  tidy_le %>% 
  filter(latin %in% Latin) %>% 
  mutate(b = n  * 0.01 * length^3 / 1e3)
```



**... end HERE for now**
```{r}
knitr::opts_chunk$set(eval = FALSE)
```

# Annual length frequency distributions
___

The first step is to sum the data in each length group by year:
```{r}
d <-
  d %>% 
  left_join(st %>% select(id, year)) %>% 
  group_by(latin, year, length) %>% 
  summarise(n = sum(n),
            b = sum(b))
```

Recalling that the number of stations is not the same each year and noting that  stations were no fish of the species in question is observed are not accounted for in the length dataframe we need to take that into account before proceeding. Hence we must:

* Calculate the number of stations taken each year
* Join that with the length data
* Calculate the mean number of fish caught in each length class

```{r}
st.no <- 
  st %>% 
  group_by(year) %>% 
  summarise(N = n())
d <-
  d %>% 
  left_join(st.no) %>% 
  mutate(n = n / N,
         b = b / N)
```

We are now ready to proceed with some visualization and inference:
```{r}
d %>% 
  ggplot(aes(length, n)) +
  geom_polygon(stat = "identity", fill = "grey") +
  facet_wrap(~ year) +
  scale_x_continuous(limits = c(9, 40))
```

<div class="panel panel-warning">
<div class="panel-heading">Exercise</div>
<div class="panel-body">

1. What is the unit of abundance (y-axis)?
2. What are the main patterns in the data?
3. Think of a better way to present the data, e.g. over a limited range of year
4. Modify that plot showing distribution of the biomass by length. What are the main differences?

```{r, echo = FALSE, eval = FALSE}
d %>% 
  filter(year %in% 1999:2004) %>% 
  ggplot(aes(length, b)) +
  geom_polygon(stat = "identity", fill = "grey") +
  facet_grid(year ~ .) +
  scale_x_continuous(limits = c(9, 40))
```

</div>
</div>

```{r}
d %>% 
  filter(year %in% 1999:2013) %>% 
  ggplot(aes(length, factor(year), height = n)) +
  geom_joy(scale = 3.5, stat = "identity", alpha = 0.2, fill = "red") +
  scale_x_continuous(limits = c(9, 40)) +
  theme_joy() +
  labs(x = "Length [cm]", y = NULL)
```
